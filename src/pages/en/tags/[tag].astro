---
import { getCollection } from 'astro:content';
import BaseLayout from '../../../layouts/BaseLayout.astro';
import FactpackCard from '../../../components/FactpackCard.astro';
import TagBadge from '../../../components/TagBadge.astro';
import { useTranslations } from '../../../i18n/utils';
import type { Lang } from '../../../i18n/languages';

const lang: Lang = 'en';
const t = useTranslations(lang);

export async function getStaticPaths() {
  const factpacks = await getCollection('factpacks_en', ({ data }) => !data.draft);
  const allTags = [...new Set(factpacks.flatMap((fp) => fp.data.tags))];

  return allTags.map((tag) => ({
    params: { tag },
    props: {
      tag,
      factpacks: factpacks
        .filter((fp) => fp.data.tags.includes(tag))
        .sort((a, b) => b.data.publishedDate.getTime() - a.data.publishedDate.getTime()),
    },
  }));
}

const { tag, factpacks } = Astro.props;
const tagKey = `tag.${tag}` as any;
const tagLabel = t(tagKey);
---

<BaseLayout
  title={`${tagLabel} | ${t('site.title')}`}
  description={`${t('tags.factpacksTagged')} "${tagLabel}"`}
  lang={lang}
>
  <section class="max-w-4xl mx-auto px-4 py-12">
    <nav class="mb-6 font-sans text-sm text-muted">
      <a href={`/${lang}/`} class="hover:text-ink transition-colors">{t('nav.home')}</a>
      <span class="mx-2">/</span>
      <span>{t('tags.title')}</span>
      <span class="mx-2">/</span>
      <span class="text-ink">{tagLabel}</span>
    </nav>

    <header class="mb-8">
      <h1 class="text-3xl md:text-4xl font-sans font-bold text-ink leading-tight mb-3">
        {tagLabel}
      </h1>
      <p class="text-muted font-sans">
        {t('tags.factpacksTagged')} <TagBadge tag={tag} lang={lang} />
      </p>
    </header>

    <div class="grid gap-4 md:grid-cols-2">
      {factpacks.map((fp) => (
        <FactpackCard
          slug={fp.id}
          title={fp.data.title}
          summary={fp.data.summary}
          verdict={fp.data.verdict}
          verdictSummary={fp.data.verdictSummary}
          tags={fp.data.tags}
          publishedDate={fp.data.publishedDate}
          sourceCount={fp.data.sources?.length}
          lang={lang}
        />
      ))}
    </div>
  </section>

  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "BreadcrumbList",
    "itemListElement": [
      { "@type": "ListItem", "position": 1, "name": t('nav.home'), "item": `https://source-check.org/${lang}/` },
      { "@type": "ListItem", "position": 2, "name": t('tags.title'), "item": `https://source-check.org/${lang}/tags/` },
      { "@type": "ListItem", "position": 3, "name": tagLabel },
    ],
  })} />
</BaseLayout>
